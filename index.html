<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Web Flores Timur</title>

    <!-- Eksternal CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <!-- CSS untuk Plugin Search -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.src.css" />

    <style>
        html, body { margin: 0; padding: 0; height: 100%; }
        body { display: flex; flex-direction: column; }
        #map { flex-grow: 1; width: 100%; }

        .leaflet-control-layers { max-height: 70vh; max-width: 280px; overflow-y: auto; }
        @media (min-width: 768px) { .leaflet-control-layers { max-height: 80vh; max-width: 350px; } }
        .leaflet-control-layers-overlays > label { display: block; padding: 5px 10px; border-bottom: 1px solid #eee; }
        .leaflet-control-layers-overlays label:last-child { border-bottom: none; }

        .legend-details { margin-top: 8px; }
        .legend-details summary { font-size: 12px; cursor: pointer; color: #007bff; }
        .legend-container { padding: 5px 0 0 10px; font-size: 12px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .legend-symbol { width: 25px; height: 20px; margin-right: 10px; position: relative; display: inline-block; }
        .legend-symbol i { position: absolute; left: 0; top: 50%; transform: translateY(-50%); height: 0; width: 100%; border-style: solid; border-width: 0; }
        .legend-symbol .polygon-symbol { width: 18px; height: 18px; opacity: 0.8; }
        .legend-symbol img { max-width: 100%; max-height: 100%; }

        .leaflet-control-layers-toggle { width: 36px !important; height: 36px !important; background-size: 26px 26px; background-color: white; border-radius: 4px; border: 2px solid rgba(0,0,0,0.2); }
        .custom-tooltip { background-color: rgba(0,0,0,0.75); color: white; border: none; border-radius: 4px; padding: 5px 10px; }
        .custom-tooltip .leaflet-tooltip-tip { background-color: rgba(0,0,0,0.75); }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark"><div class="container-fluid"><a class="navbar-brand" href="#"><i class="fa-solid fa-map-location-dot me-2"></i>Peta Flores Timur</a><button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNav"><ul class="navbar-nav ms-auto"><li class="nav-item"><a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#aboutModal"><i class="fa-solid fa-circle-info me-1"></i>Tentang</a></li></ul></div></div></nav>
    <div id="map"></div>
    <div class="modal fade" id="featureModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="featureModalLabel">Detail</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="modalBodyContent"></div></div></div></div>
    <div class="modal fade" id="aboutModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Tentang Aplikasi</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><p>Peta ini dibuat oleh:</p><div class="card bg-light"><div class="card-body"><h5 class="card-title">Hilmi Ahmad Dzakwan</h5><p class="card-text mb-0">NIM: 24/543063/SV/25150</p><p class="card-text">Kelas: B</p></div></div></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- JS untuk Plugin Search -->
    <script src="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.src.js"></script>

    <script>
        var map = L.map('map').setView([-8.34, 122.98], 11);

        map.createPane('batasPane'); map.getPane('batasPane').style.zIndex = 410;
        map.createPane('sungaiPane'); map.getPane('sungaiPane').style.zIndex = 420;
        map.createPane('jalanPane'); map.getPane('jalanPane').style.zIndex = 430;

        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' });
        var esriSatelit = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' });
        osm.addTo(map);
        var baseMaps = { "OpenStreetMap": osm, "Esri Satelit": esriSatelit };
        L.control.scale({ imperial: false, position: 'bottomleft' }).addTo(map);

        function getKecamatanColor(p) { return p > 30000 ? '#8B4513' : p > 15000 ? '#D2691E' : '#F4A460'; }
        function getJalanCasingStyle(j) { switch (j) { case 'Jalan Propinsi': return { color: '#000', weight: 5, opacity: .8 }; case 'Jalan Kabupaten': return { color: '#964B00', weight: 4, opacity: .8 }; case 'Jalan Lain': return { color: '#A9A9A9', weight: 3, opacity: .8 }; default: return { color: '#000', weight: 2, opacity: .5 }; } }
        function getJalanFillStyle(j) { switch (j) { case 'Jalan Propinsi': return { color: '#FF0000', weight: 3 }; case 'Jalan Kabupaten': return { color: '#FFA500', weight: 2 }; case 'Jalan Lain': return { color: '#FFFF00', weight: 1.5 }; default: return { color: '#FFF', weight: 1 }; } }
        const featureModal = new bootstrap.Modal(document.getElementById('featureModal'));

        const legendFunctions = {
            "Batas Kecamatan": () => {
                const grades = [0, 15000, 30000];
                let legendHtml = '<strong>Jumlah Penduduk</strong>';
                grades.forEach((grade, index) => { const nextGrade = grades[index + 1]; legendHtml += `<div class="legend-item"><div class="legend-symbol"><i class="polygon-symbol" style="background:${getKecamatanColor(grade + 1)}"></i></div> ${grade.toLocaleString('id-ID')} ${nextGrade ? '&ndash; ' + nextGrade.toLocaleString('id-ID') : '+'}</div>`; });
                return legendHtml;
            },
            "Jalan": () => `
                <div class="legend-item"><div class="legend-symbol"><i style="border-top: 5px solid #000;"></i><i style="border-top: 3px solid #FF0000;"></i></div> Jalan Propinsi</div>
                <div class="legend-item"><div class="legend-symbol"><i style="border-top: 4px solid #964B00;"></i><i style="border-top: 2px solid #FFA500;"></i></div> Jalan Kabupaten</div>
                <div class="legend-item"><div class="legend-symbol"><i style="border-top: 3px solid #A9A9A9;"></i><i style="border-top: 1.5px solid #FFFF00;"></i></div> Jalan Lain</div>
            `,
            "Batas Desa": () => `<div class="legend-item"><div class="legend-symbol"><i style="border-top: 2px dashed #ffa500; width: 100%;"></i></div> Batas Administrasi Desa</div>`,
            "Sungai": () => `<div class="legend-item"><div class="legend-symbol"><i style="border-top: 2px solid #00BFFF; width: 100%;"></i></div> Alur Sungai</div>`,
            "Toponimi": () => `<div class="legend-item"><div class="legend-symbol"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png" style="width:12px;"></div> Lokasi/Titik</div>`
        };

        Promise.all([
            fetch('data/batas_kecamatan.geojson').then(res => res.json()),
            fetch('data/batas_desa.geojson').then(res => res.json()),
            fetch('data/jalan.geojson').then(res => res.json()),
            fetch('data/sungai.geojson').then(res => res.json()),
            fetch('data/toponimi.geojson').then(res => res.json())
        ]).then(([kecamatanData, desaData, jalanData, sungaiData, toponimiData]) => {
            const overlayMaps = {};

            // Normalisasi data untuk pencarian
            kecamatanData.features.forEach(f => f.properties.searchName = f.properties.WADMKC);
            desaData.features.forEach(f => f.properties.searchName = f.properties.WADMKD);

            const kecamatanLayer = L.geoJSON(kecamatanData, { pane: 'batasPane', style: f => ({ fillColor: getKecamatanColor(f.properties.Penduduk), weight: 2, opacity: 1, color: 'white', dashArray: '3', fillOpacity: .8 }), onEachFeature: (f, l) => { l.bindTooltip(f.properties.WADMKC, { sticky: true, className: 'custom-tooltip' }); l.on('click', e => { const p = e.target.feature.properties; document.getElementById('featureModalLabel').innerText = `Kecamatan ${p.WADMKC}`; document.getElementById('modalBodyContent').innerHTML = `<ul class="list-group"><li class="list-group-item d-flex justify-content-between align-items-center"><span><i class="fa-solid fa-users me-2"></i>Jumlah Penduduk</span><span class="badge bg-primary rounded-pill">${p.Penduduk.toLocaleString('id-ID')}</span></li></ul>`; featureModal.show(); }); } }).addTo(map);
            overlayMaps["Batas Kecamatan"] = kecamatanLayer;

            const desaLayer = L.geoJSON(desaData, { pane: 'batasPane', style: { color: "#ffa500", weight: 1.5, opacity: .8, dashArray: '2, 6' }, onEachFeature: (f, l) => { if (f.properties.WADMKD) l.bindPopup('<strong>Desa:</strong> ' + f.properties.WADMKD); } });
            overlayMaps["Batas Desa"] = desaLayer;

            const jalanCasing = L.geoJSON(jalanData, { pane: 'jalanPane', style: f => getJalanCasingStyle(f.properties.NAMA_UNSUR) });
            const jalanFill = L.geoJSON(jalanData, { pane: 'jalanPane', style: f => getJalanFillStyle(f.properties.NAMA_UNSUR), onEachFeature: (f, l) => { if (f.properties.NAMA_UNSUR) l.bindPopup('<strong>Jenis:</strong> ' + f.properties.NAMA_UNSUR); } });
            overlayMaps["Jalan"] = L.layerGroup([jalanCasing, jalanFill]);

            const sungaiLayer = L.geoJSON(sungaiData, { pane: 'sungaiPane', style: { color: "#00BFFF", weight: 2 }, onEachFeature: (f, l) => { if (f.properties.NAMSNG) l.bindPopup('<strong>Sungai:</strong> ' + f.properties.NAMSNG); } });
            overlayMaps["Sungai"] = sungaiLayer;

            const toponimiLayer = L.geoJSON(toponimiData, { onEachFeature: (f, l) => { if (f.properties.NAMOBJ) l.bindPopup('<strong>Lokasi:</strong> ' + f.properties.NAMOBJ); } });
            overlayMaps["Toponimi"] = toponimiLayer;

            const layerControl = L.control.layers(baseMaps, overlayMaps).addTo(map);

            const overlaysContainer = layerControl.getContainer().querySelector('.leaflet-control-layers-overlays');
            overlaysContainer.querySelectorAll('label').forEach(label => {
                const layerName = label.querySelector('span').innerText.trim();
                if (legendFunctions[layerName]) {
                    const legendHTML = legendFunctions[layerName]();
                    const details = document.createElement('details');
                    details.className = 'legend-details';
                    details.innerHTML = `<summary>Lihat Legenda</summary><div class="legend-container">${legendHTML}</div>`;
                    label.appendChild(details);
                }
            });

            // --- Inisialisasi Kontrol Pencarian ---
            const searchLayer = L.layerGroup([kecamatanLayer, desaLayer]);
            const searchControl = new L.Control.Search({
                layer: searchLayer,
                propertyName: 'searchName', // Properti yang sudah dinormalisasi
                initial: false,
                zoom: 14,
                marker: false, // Tidak perlu marker tambahan, kita akan highlight poligonnya
                textPlaceholder: 'Cari desa/kecamatan...',
                moveToLocation: function(latlng, title, map) {
                    map.flyTo(latlng, 14); // Gunakan flyTo untuk animasi yang lebih halus
                }
            });

            // Event saat lokasi ditemukan
            searchControl.on('search:locationfound', function(e) {
                e.layer.setStyle({ color: '#00FFFF', weight: 3 }); // Highlight dengan warna cyan
                if(e.layer._popup) e.layer.openPopup();
                // Hapus highlight setelah beberapa saat
                setTimeout(() => e.layer.setStyle(e.sourceTarget.options.style(e.layer.feature)), 3000);
            });

            map.addControl(searchControl);

        }).catch(error => console.error("Gagal memuat data peta:", error));

    </script>

</body>
</html>